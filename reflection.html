<!DOCTYPE html>
<html>

<head>
    <title>DAE Viewer with Reflection and GUI Controls</title>
</head>

<body>
    <div id="container" style="width:100vw; height:100vh;"></div>
    <script type="importmap">
        {
            "imports": {
                "three": "./three/build/three.module.js",
                "three/addons/": "./three/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import Stats from 'three/addons/libs/stats.module.js';
        import { GUI } from 'three/addons/libs/lil-gui.module.min.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { ColladaLoader } from 'three/addons/loaders/ColladaLoader.js';
        import { SSRPass } from 'three/addons/postprocessing/SSRPass.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';

        const container = document.getElementById('container');
        let renderer, scene, camera, stats, composer, ssrPass;
        let elf;

        // Reflection parameters
        let params = {
            intensity: 0,
            distance: 0.02,
            blur: 0,
            fresnel: 1,
            thickness: 0.1,
            maxRoughness: 0.01,
            opacity: 0  // New opacity parameter
        };

        init();

        function init() {
            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            // Stats setup
            stats = new Stats();
            container.appendChild(stats.dom);

            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xdddddd);  // Light background

            // Camera setup
            camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.set(0, 10, 150);

            // Controls setup
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.minDistance = 50;
            controls.maxDistance = 300;

            // Ambient light
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));

            // Directional light
            const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
            dirLight.position.set(1, 0.75, 0.5);
            scene.add(dirLight);

            // Load Collada model
            const loader = new ColladaLoader();
            loader.load('./assets/models/texture2.dae', function (collada) {
                elf = collada.scene;
                elf.scale.set(0.4, 0.4, 0.4);
                elf.position.set(0, -25, 0);
                elf.traverse(function (node) {
                    if (node.isMesh) {
                        node.material.transparent = false;  // Disable transparency
                        node.material.opacity = 1;          // Ensure opacity is set to 1
                    }
                });
                scene.add(elf);

                setupSSRPass();  // Set up SSR after the model is loaded
            });

            // Handle window resize
            window.addEventListener('resize', onWindowResize);

            // GUI setup
            const gui = new GUI();
            gui.add(params, 'intensity', 0, 2).onChange(() => updateReflection());
            gui.add(params, 'distance', 0, 2).onChange(() => updateReflection());
            gui.add(params, 'blur', 0, 1).onChange(() => updateReflection());
            gui.add(params, 'fresnel', 0, 2).onChange(() => updateReflection());
            gui.add(params, 'thickness', 0, 1).onChange(() => updateReflection());
            gui.add(params, 'maxRoughness', 0, 1).onChange(() => updateReflection());
            gui.add(params, 'opacity', 0, 1).onChange(() => updateReflection());  // Opacity control
            gui.open();
        }

        function setupSSRPass() {
            // Render pass
            const renderPass = new RenderPass(scene, camera);

            // SSR pass setup
            ssrPass = new SSRPass({
                renderer: renderer,
                scene: scene,
                camera: camera,
                // intensity: params.intensity * params.opacity,
                // distance: params.distance,
                // blur: params.blur,
                // fresnel: params.fresnel,
                // thickness: params.thickness,
                // maxRoughness: params.maxRoughness
            });

            // Composer setup
            composer = new EffectComposer(renderer);
            composer.addPass(renderPass);
            composer.addPass(ssrPass);
        }

        function updateReflection() {
            if (ssrPass) {
                // Update SSRPass parameters dynamically
                // ssrPass.intensity = params.intensity * params.opacity;  // Modifying intensity by opacity
                // ssrPass.distance = params.distance;
                // ssrPass.blur = params.blur;
                // ssrPass.fresnel = params.fresnel;
                // ssrPass.thickness = params.thickness;
                // ssrPass.maxRoughness = params.maxRoughness;

                // // Ensure that the pass is re-rendered
                // ssrPass.needsSwap = true;  // Trigger update
                // composer.passes[1] = ssrPass; // Ensure pass update
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            if (composer) {
                composer.setSize(window.innerWidth, window.innerHeight);
            }
        }

        function animate() {
            // Apply reflection changes dynamically
            updateReflection();

            if (composer) {
                composer.render();
            } else {
                renderer.render(scene, camera);
            }

            // Update performance stats
            stats.update();
        }

        renderer.setAnimationLoop(animate);
    </script>
</body>

</html>